<!doctype html>
<meta charset="utf-8">
<title>SMS Spam Naive Bayes - Report</title>
<style>
 body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial; margin: 20px; }
 h1,h2 { margin: 14px 0; }
 table { border-collapse: collapse; width:100%; } th,td { border:1px solid #ddd; padding:6px 8px; } th{background:#fafafa}
 img { max-width:100%; height:auto; }
 pre { background:#f7f7f7; padding:12px; border-radius:8px; white-space:pre-wrap; word-break:break-word; }
 details > summary { cursor:pointer; font-weight:600; }
 .muted { color:#666; font-size:0.95em; }
</style>
<h1>SMS Spam Naive Bayes - Report</h1>
<ul>
  <li>Accuracy: 0.9785</li>
  <li>Precision (macro): 0.9429</li>
  <li>Recall (macro): 0.9677</li>
  <li>F1 (macro): 0.9548</li>
</ul>
<h2>Confusion Matrix</h2>
<img src="confusion_matrix.png" alt="confusion matrix">
<h2>Predicted Class Counts (10 Messages)</h2>
<img src="messages_pred_counts.png" alt="pred counts">
<h2>Predictions for 10 Messages</h2>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th>id</th>
      <th>message</th>
      <th>prediction</th>
      <th>P_ham</th>
      <th>P_spam</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>1</td>
      <td>how are you .fine, thank you and you?</td>
      <td>ham</td>
      <td>9.935948e-01</td>
      <td>0.006405</td>
    </tr>
    <tr>
      <td>2</td>
      <td>Good News, You've won a big prize, please call 00861888888888 for more information</td>
      <td>spam</td>
      <td>4.978990e-03</td>
      <td>0.995021</td>
    </tr>
    <tr>
      <td>3</td>
      <td>are you ok</td>
      <td>ham</td>
      <td>8.658290e-01</td>
      <td>0.134171</td>
    </tr>
    <tr>
      <td>4</td>
      <td>not at all</td>
      <td>ham</td>
      <td>8.658290e-01</td>
      <td>0.134171</td>
    </tr>
    <tr>
      <td>5</td>
      <td>WINNER, You have won a 1 week FREE membership in our £100,000 Prize Jackpot!</td>
      <td>spam</td>
      <td>4.740179e-09</td>
      <td>1.000000</td>
    </tr>
    <tr>
      <td>6</td>
      <td>winner winner chicken dinner</td>
      <td>spam</td>
      <td>2.351027e-01</td>
      <td>0.764897</td>
    </tr>
    <tr>
      <td>7</td>
      <td>Congratulations on your invitation to join Honor Society!</td>
      <td>spam</td>
      <td>5.293277e-02</td>
      <td>0.947067</td>
    </tr>
    <tr>
      <td>8</td>
      <td>I love you guys.</td>
      <td>ham</td>
      <td>9.959454e-01</td>
      <td>0.004055</td>
    </tr>
    <tr>
      <td>9</td>
      <td>Extra large discount, three bamboo rats and three 10 yuan</td>
      <td>spam</td>
      <td>8.949609e-02</td>
      <td>0.910504</td>
    </tr>
    <tr>
      <td>10</td>
      <td>good good study day day up</td>
      <td>ham</td>
      <td>9.987550e-01</td>
      <td>0.001245</td>
    </tr>
  </tbody>
</table>
<h2>Source Code</h2>
<p class="muted">下面展示的是本页面生成脚本的完整源码。</p>
<p><a href='publish_report.py' download>⬇ 下载 publish_report.py</a></p>
<details open>
  <summary>展开/收起 源码</summary>
  <pre># -*- coding: utf-8 -*-
# 训练+生成报告到 site/ → 推送到 GitHub Pages → 生成永久二维码（包含源码展示/下载）
import os, re, string, math, html as html_lib, subprocess, sys, shutil
import numpy as np
import pandas as pd
from collections import defaultdict
from sklearn.model_selection import train_test_split
from sklearn.metrics import accuracy_score, precision_score, recall_score, f1_score, confusion_matrix, classification_report

import matplotlib
matplotlib.use(&quot;Agg&quot;)
import matplotlib.pyplot as plt

try:
    import qrcode
except Exception:
    print(&#x27;缺少依赖：请先执行  pip install &quot;qrcode[pil]&quot;&#x27;)
    sys.exit(1)

# ========= 配置（按需修改） =========
REPO_URL = &quot;https://github.com/qiuben1/sms-spam-report.git&quot;
BRANCH   = &quot;main&quot;
OUT_DIR  = &quot;site&quot;
# ==================================

# ---------- 数据 ----------
def load_stopwords(path=&quot;stopwords.txt&quot;):
    with open(path, &quot;r&quot;, encoding=&quot;utf-8&quot;, errors=&quot;ignore&quot;) as f:
        return set(w.strip() for w in f if w.strip())
stopwords = load_stopwords(&quot;stopwords.txt&quot;)
data = pd.read_csv(&quot;SMSSpamCollection.txt&quot;, sep=&quot;\t&quot;, header=None, names=[&quot;labels&quot;, &quot;messages&quot;])
X, y = data[&quot;messages&quot;], data[&quot;labels&quot;]
print(&quot;数据前5行：\n&quot;, data.head())

# ---------- 预处理 ----------
_punc_re = re.compile(f&#x27;[{re.escape(string.punctuation)}]&#x27;)
def preprocess(text: str):
    text = text.lower()
    text = _punc_re.sub(&quot; &quot;, text)
    return [w for w in text.split() if w not in stopwords]

# ---------- 朴素贝叶斯 ----------
class NaiveBayesClassifier:
    def __init__(self, alpha: float = 1.0):
        self.alpha = float(alpha)
        self.vocabulary = set()
        self.class_total = defaultdict(int)
        self.word_total  = defaultdict(int)
        self.word_given_class = defaultdict(lambda: defaultdict(int))
        self.classes_, self.vocab_size, self.log_prior_ = [], 0, {}

    def fit(self, X_iter, y_iter):
        for text, label in zip(X_iter, y_iter):
            words = preprocess(text)
            self.class_total[label] += 1
            for w in words:
                self.vocabulary.add(w)
                self.word_given_class[label][w] += 1
                self.word_total[label] += 1
        self.classes_ = list(self.class_total.keys())
        self.vocab_size = len(self.vocabulary)
        N = sum(self.class_total.values())
        self.log_prior_ = {c: math.log(self.class_total[c] / N) for c in self.classes_}
        return self

    def _log_like_sum(self, tokens, c: str) -&gt; float:
        denom = self.word_total[c] + self.alpha * self.vocab_size
        s = 0.0
        for w in tokens:
            num = self.word_given_class[c].get(w, 0) + self.alpha
            s += math.log(num / denom)
        return s

    def predict_log_proba(self, X_iter):
        if isinstance(X_iter, str): X_iter = [X_iter]
        out = []
        for text in X_iter:
            toks = preprocess(text)
            scores = [self.log_prior_[c] + self._log_like_sum(toks, c) for c in self.classes_]
            m = max(scores); exps = [math.exp(s - m) for s in scores]; Z = sum(exps)
            out.append([math.log(e / Z) for e in exps])
        return np.array(out)

    def predict_proba(self, X_iter):
        return np.exp(self.predict_log_proba(X_iter))

    def predict(self, X_iter):
        if isinstance(X_iter, str): X_iter = [X_iter]
        logp = self.predict_log_proba(X_iter)
        idx = logp.argmax(axis=1)
        return np.array([self.classes_[i] for i in idx])

# ---------- 训练评估 ----------
X_train, X_test, y_train, y_test = train_test_split(X, y, stratify=y, test_size=0.2, random_state=42)
clf = NaiveBayesClassifier(alpha=1.0).fit(X_train, y_train)
y_pred = clf.predict(X_test)

label_order = [&quot;ham&quot;,&quot;spam&quot;]
y_true = np.asarray(y_test); y_pred = np.asarray(y_pred)
acc  = accuracy_score(y_true, y_pred)
prec = precision_score(y_true, y_pred, labels=label_order, average=&quot;macro&quot;, zero_division=0)
rec  = recall_score(y_true, y_pred, labels=label_order, average=&quot;macro&quot;, zero_division=0)
f1   = f1_score(y_true, y_pred, labels=label_order, average=&quot;macro&quot;, zero_division=0)
cm   = confusion_matrix(y_true, y_pred, labels=label_order)

print(f&quot;\nAccuracy: {acc:.4f}&quot;)
print(f&quot;Precision(macro): {prec:.4f}  Recall(macro): {rec:.4f}  F1(macro): {f1:.4f}&quot;)
print(&quot;\nConfusion Matrix:\n&quot;, cm)
print(&quot;\nClassification Report:\n&quot;,
      classification_report(y_true, y_pred, labels=label_order, target_names=label_order, digits=4, zero_division=0))

# ---------- 10 段文本 ----------
messages = [
    &#x27;how are you .fine, thank you and you?&#x27;,
    &quot;Good News, You&#x27;ve won a big prize, please call 00861888888888 for more information&quot;,
    &#x27;are you ok&#x27;,
    &#x27;not at all&#x27;,
    &#x27;WINNER, You have won a 1 week FREE membership in our £100,000 Prize Jackpot!&#x27;,
    &#x27;winner winner chicken dinner&#x27;,
    &#x27;Congratulations on your invitation to join Honor Society!&#x27;,
    &#x27;I love you guys.&#x27;,
    &#x27;Extra large discount, three bamboo rats and three 10 yuan&#x27;,
    &#x27;good good study day day up&#x27;
]
pred_ms  = clf.predict(messages)
proba_ms = clf.predict_proba(messages)
cls2idx  = {c:i for i,c in enumerate(clf.classes_)}
p_ham, p_spam = proba_ms[:, cls2idx[&quot;ham&quot;]], proba_ms[:, cls2idx[&quot;spam&quot;]]

df_out = pd.DataFrame({&quot;id&quot;:range(1,len(messages)+1),
                       &quot;message&quot;:messages,
                       &quot;prediction&quot;:pred_ms,
                       &quot;P_ham&quot;:p_ham, &quot;P_spam&quot;:p_spam})

# ---------- 生成静态站点 ----------
os.makedirs(OUT_DIR, exist_ok=True)

def save_cm_img(cm, labels, path_png):
    plt.figure(figsize=(4.8,4.2))
    plt.imshow(cm, cmap=&quot;Blues&quot;)
    plt.title(&quot;Confusion Matrix&quot;); plt.xlabel(&quot;Predicted&quot;); plt.ylabel(&quot;True&quot;)
    plt.xticks(range(len(labels)), labels); plt.yticks(range(len(labels)), labels)
    for i in range(cm.shape[0]):
        for j in range(cm.shape[1]):
            plt.text(j,i,int(cm[i,j]),ha=&quot;center&quot;,va=&quot;center&quot;)
    plt.tight_layout(); plt.savefig(path_png, dpi=200, bbox_inches=&quot;tight&quot;); plt.close()

def save_counts_bar(preds, path_png):
    counts = pd.Series(preds).value_counts().reindex([&quot;ham&quot;,&quot;spam&quot;]).fillna(0)
    plt.figure(figsize=(4.8,3.0))
    plt.bar(counts.index, counts.values)
    for x,v in zip(counts.index, counts.values):
        plt.text(x, v+0.05, int(v), ha=&quot;center&quot;)
    plt.title(&quot;Predicted Class Counts for 10 Messages&quot;); plt.ylabel(&quot;Count&quot;)
    plt.tight_layout(); plt.savefig(path_png, dpi=200, bbox_inches=&quot;tight&quot;); plt.close()

save_cm_img(cm, label_order, os.path.join(OUT_DIR,&quot;confusion_matrix.png&quot;))
save_counts_bar(pred_ms, os.path.join(OUT_DIR,&quot;messages_pred_counts.png&quot;))
df_out.to_csv(os.path.join(OUT_DIR,&quot;messages_predictions.csv&quot;), index=False, encoding=&quot;utf-8&quot;)

# === 新增：读取并复制源码到 site/，并在页面展示 ===
SRC_PATH = os.path.abspath(__file__) if &quot;__file__&quot; in globals() else None
try:
    code_text = open(SRC_PATH, &quot;r&quot;, encoding=&quot;utf-8&quot;, errors=&quot;ignore&quot;).read()
except Exception:
    code_text, SRC_PATH = &quot;# 源代码读取失败&quot;, None

code_html = html_lib.escape(code_text)  # 转义后放 &lt;pre&gt; 里
download_name = None
if SRC_PATH:
    try:
        download_name = os.path.basename(SRC_PATH)
        shutil.copy2(SRC_PATH, os.path.join(OUT_DIR, download_name))
    except Exception as e:
        print(&quot;[WARN] 复制源码到 site/ 失败：&quot;, e)
        download_name = None

html = f&quot;&quot;&quot;&lt;!doctype html&gt;
&lt;meta charset=&quot;utf-8&quot;&gt;
&lt;title&gt;SMS Spam Naive Bayes - Report&lt;/title&gt;
&lt;style&gt;
 body {{ font-family: -apple-system, BlinkMacSystemFont, &quot;Segoe UI&quot;, Roboto, &quot;Helvetica Neue&quot;, Arial; margin: 20px; }}
 h1,h2 {{ margin: 14px 0; }}
 table {{ border-collapse: collapse; width:100%; }} th,td {{ border:1px solid #ddd; padding:6px 8px; }} th{{background:#fafafa}}
 img {{ max-width:100%; height:auto; }}
 pre {{ background:#f7f7f7; padding:12px; border-radius:8px; white-space:pre-wrap; word-break:break-word; }}
 details &gt; summary {{ cursor:pointer; font-weight:600; }}
 .muted {{ color:#666; font-size:0.95em; }}
&lt;/style&gt;
&lt;h1&gt;SMS Spam Naive Bayes - Report&lt;/h1&gt;
&lt;ul&gt;
  &lt;li&gt;Accuracy: {acc:.4f}&lt;/li&gt;
  &lt;li&gt;Precision (macro): {prec:.4f}&lt;/li&gt;
  &lt;li&gt;Recall (macro): {rec:.4f}&lt;/li&gt;
  &lt;li&gt;F1 (macro): {f1:.4f}&lt;/li&gt;
&lt;/ul&gt;
&lt;h2&gt;Confusion Matrix&lt;/h2&gt;
&lt;img src=&quot;confusion_matrix.png&quot; alt=&quot;confusion matrix&quot;&gt;
&lt;h2&gt;Predicted Class Counts (10 Messages)&lt;/h2&gt;
&lt;img src=&quot;messages_pred_counts.png&quot; alt=&quot;pred counts&quot;&gt;
&lt;h2&gt;Predictions for 10 Messages&lt;/h2&gt;
{df_out.to_html(index=False, escape=True)}
&lt;h2&gt;Source Code&lt;/h2&gt;
&lt;p class=&quot;muted&quot;&gt;下面展示的是本页面生成脚本的完整源码。&lt;/p&gt;
{&quot;&lt;p&gt;&lt;a href=&#x27;&quot; + download_name + &quot;&#x27; download&gt;⬇ 下载 publish_report.py&lt;/a&gt;&lt;/p&gt;&quot; if download_name else &quot;&quot;}
&lt;details open&gt;
  &lt;summary&gt;展开/收起 源码&lt;/summary&gt;
  &lt;pre&gt;{code_html}&lt;/pre&gt;
&lt;/details&gt;
&quot;&quot;&quot;
open(os.path.join(OUT_DIR,&quot;index.html&quot;), &quot;w&quot;, encoding=&quot;utf-8&quot;).write(html)
print(&quot;已生成静态站点：&quot;, os.path.abspath(OUT_DIR))

# ---------- 推送到 GitHub ----------
def run(cmd, cwd):
    env = os.environ.copy()
    env.update({&quot;LC_ALL&quot;:&quot;C.UTF-8&quot;,&quot;LANG&quot;:&quot;C.UTF-8&quot;})
    res = subprocess.run(cmd, cwd=cwd, text=True, capture_output=True,
                         encoding=&quot;utf-8&quot;, errors=&quot;ignore&quot;, env=env)
    if res.returncode != 0:
        print(&quot;命令失败:&quot;, &quot; &quot;.join(cmd))
        if res.stdout: print(&quot;STDOUT:\n&quot;, res.stdout)
        if res.stderr: print(&quot;STDERR:\n&quot;, res.stderr)
    return res

def publish(out_dir, repo_url, branch=&quot;main&quot;):
    if not os.path.isdir(os.path.join(out_dir, &quot;.git&quot;)):
        run([&quot;git&quot;,&quot;init&quot;,&quot;-b&quot;,branch], out_dir)

    m = re.match(r&quot;https://github\.com/([^/]+)/([^/.]+)(?:\.git)?&quot;, repo_url)
    username = m.group(1) if m else &quot;pages-bot&quot;
    run([&quot;git&quot;,&quot;config&quot;,&quot;user.name&quot;, username], out_dir)
    run([&quot;git&quot;,&quot;config&quot;,&quot;user.email&quot;, f&quot;{username}@users.noreply.github.com&quot;], out_dir)

    cur = run([&quot;git&quot;,&quot;remote&quot;,&quot;get-url&quot;,&quot;origin&quot;], out_dir)
    if cur.returncode != 0:
        run([&quot;git&quot;,&quot;remote&quot;,&quot;add&quot;,&quot;origin&quot;, repo_url], out_dir)
    else:
        run([&quot;git&quot;,&quot;remote&quot;,&quot;set-url&quot;,&quot;origin&quot;, repo_url], out_dir)

    ls = run([&quot;git&quot;,&quot;ls-remote&quot;,&quot;--heads&quot;,&quot;origin&quot;, branch], out_dir)
    if ls.returncode == 0 and ls.stdout.strip():
        run([&quot;git&quot;,&quot;fetch&quot;,&quot;origin&quot;, branch], out_dir)
        run([&quot;git&quot;,&quot;checkout&quot;,&quot;-B&quot;, branch, f&quot;origin/{branch}&quot;], out_dir)
    else:
        run([&quot;git&quot;,&quot;checkout&quot;,&quot;-B&quot;, branch], out_dir)

    run([&quot;git&quot;,&quot;add&quot;,&quot;.&quot;], out_dir)
    cmt = run([&quot;git&quot;,&quot;commit&quot;,&quot;-m&quot;,&quot;update report&quot;], out_dir)
    if cmt.returncode != 0 and &quot;nothing to commit&quot; not in (cmt.stdout+cmt.stderr).lower():
        return False
    push = run([&quot;git&quot;,&quot;push&quot;,&quot;-u&quot;,&quot;origin&quot;, branch], out_dir)
    return push.returncode == 0

ok = publish(OUT_DIR, REPO_URL, BRANCH)
if not ok:
    print(&quot;\n推送失败：请确认已登录 GitHub（或在提示时输入 PAT），以及 REPO_URL 正确。&quot;)
    sys.exit(1)

# ---------- 生成永久二维码（Pages 链接） ----------
def pages_url_from_repo(repo_url: str):
    m = re.match(r&quot;https://github\.com/([^/]+)/([^/.]+)(?:\.git)?&quot;, repo_url)
    if not m: return None
    user, repo = m.groups()
    return f&quot;https://{user}.github.io/{repo}/&quot;

pages_url = pages_url_from_repo(REPO_URL)
qr_path = os.path.join(OUT_DIR, &quot;permanent_qr.png&quot;)
qrcode.make(pages_url).save(qr_path)

print(&quot;\n✅ 已发布到 GitHub Pages：&quot;, pages_url)
print(&quot;✅ 永久二维码已生成：&quot;, os.path.abspath(qr_path))
print(&quot;（首次启用 Pages 可能延迟 1–2 分钟再刷新/扫码）&quot;)
</pre>
</details>
